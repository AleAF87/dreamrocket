<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Dream Rocket</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">

    <!-- Firebase Scripts -->
    <script type="module" src="js/firebase-config.js"></script>
    
    <!-- Prote√ß√£o de p√°gina -->
    <script type="module">
        import { protectPage } from "./js/auth.js";
        protectPage();
    </script>
</head>

<body>
    <!-- NAVBAR -->
    <div id="navbar"></div>

    <h2>Dashboard de Movimenta√ß√µes</h2>

    <div class="dash-container">

        <!-- LISTA DE LAN√áAMENTOS -->
        <div class="list-area">
            <h3>Lan√ßamentos</h3>
            
            <!-- Filtros -->
            <div class="filters-container">
                <div class="filter-group">
                    <label for="sortFilter">Ordenar por:</label>
                    <select id="sortFilter" class="filter-select">
                        <option value="processedDateDesc">Data Processada (Mais Recente)</option>
                        <option value="processedDateAsc">Data Processada (Mais Antiga)</option>
                        <option value="requestDesc">Data do Pedido (Mais Recente)</option>
                        <option value="requestAsc">Data do Pedido (Mais Antiga)</option>
                        <option value="deliveryDesc">Data de Entrega (Mais Recente)</option>
                        <option value="deliveryAsc">Data de Entrega (Mais Antiga)</option>
                        <option value="customerAsc">Cliente (A-Z)</option>
                        <option value="customerDesc">Cliente (Z-A)</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="statusFilter">Filtrar por Status:</label>
                    <select id="statusFilter" class="filter-select">
                        <option value="all">Todos os Status</option>
                        <option value="1">Conclu√≠do</option>
                        <option value="2">Em andamento</option>
                        <option value="3">Aguardando</option>
                        <option value="4">Cancelado</option>
                    </select>
                </div>
            </div>
            
            <ul id="launchList" class="list"></ul>
        </div>

        <!-- FORMUL√ÅRIO -->
        <div class="form-area">
            <h3>Editar / Novo Lan√ßamento</h3>

            <div class="form-grid">
                <input id="Customer" data-field placeholder="Cliente">
                <input id="Business" data-field placeholder="Empresa">
                <input id="Identification" data-field placeholder="Identifica√ß√£o">
                <input id="Description" data-field placeholder="Descri√ß√£o">

                <label>Data do Pedido</label>
                <input type="date" id="Request" data-field>

                <label>Data de Entrega</label>
                <input type="date" id="Delivery" data-field>

                <label>Data Processada</label>
                <input type="date" id="ProcessedDate" data-field>

                <input type="number" id="Deposit" data-field placeholder="Dep√≥sito" step="0.01">
                <input type="number" id="Expenses" data-field placeholder="Despesas (R$)" step="0.01">
                <input type="number" id="PercExpenses" data-field placeholder="Despesas (%)" step="0.01">

                <input id="Profit" placeholder="Lucro" readonly>

                <input type="number" id="Withdrawal" data-field placeholder="Retirada" step="0.01">

                <label>Status</label>
                <select id="Status" data-field>
                    <option value="1">Conclu√≠do</option>
                    <option value="2">Em andamento</option>
                    <option value="3">Aguardando</option>
                    <option value="4">Cancelado</option>
                </select>

                <textarea id="Observation" data-field placeholder="Observa√ß√µes"></textarea>

                <!-- Bot√µes de a√ß√£o -->
                <div class="button-group" style="grid-column: span 2;">
                    <button id="saveBtn" class="save-btn btn-success">Salvar Novo</button>
                    <button id="updateBtn" class="update-btn btn-primary" style="display: none;">Alterar</button>
                    <button id="clearBtn" class="clear-btn btn-danger" style="display: none;">Limpar Campos</button>
                </div>
            </div>
        </div>

    </div>

    <!-- JS DA DASHBOARD -->
    <script type="module">
        import { db, auth } from "./js/firebase-config.js";
        import { ref, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
        
        let selectedId = null;
        let formChanged = false;
        let allLaunches = []; // Armazena todos os lan√ßamentos para filtragem
        let currentSort = 'processedDateDesc';
        let currentStatusFilter = 'all';

        const list = document.getElementById("launchList");
        const fields = document.querySelectorAll("[data-field]");
        const saveBtn = document.getElementById("saveBtn");
        const updateBtn = document.getElementById("updateBtn");
        const clearBtn = document.getElementById("clearBtn");
        const sortFilter = document.getElementById("sortFilter");
        const statusFilter = document.getElementById("statusFilter");

        // Carregar a navbar e inicializar
        document.addEventListener("DOMContentLoaded", () => {
            fetch("components/navbar.html")
                .then(r => r.text())
                .then(html => {
                    document.getElementById("navbar").innerHTML = html;
                    // Inicializa eventos da navbar
                    import("./js/navbar.js").then(module => {
                        module.default();
                    });
                });
        });

        // Eventos dos filtros
        sortFilter.addEventListener("change", () => {
            currentSort = sortFilter.value;
            renderList();
        });

        statusFilter.addEventListener("change", () => {
            currentStatusFilter = statusFilter.value;
            renderList();
        });

        // Marcar altera√ß√µes e calcular despesas
        fields.forEach(f => {
            f.addEventListener("input", () => {
                formChanged = true;
                
                // Verifica se √© campo de c√°lculo
                if (f.id === "Deposit" || f.id === "Expenses" || f.id === "PercExpenses") {
                    handleExpensesCalculation();
                    updateProfit();
                }
            });
        });

        // Fun√ß√£o para calcular despesas
        function handleExpensesCalculation() {
            const deposit = parseFloat(document.getElementById("Deposit").value) || 0;
            const expensesInput = document.getElementById("Expenses");
            const percExpensesInput = document.getElementById("PercExpenses");
            
            // Se preencher Despesas (R$), calcula %
            if (document.activeElement === expensesInput && expensesInput.value) {
                const expenses = parseFloat(expensesInput.value);
                const percentage = deposit > 0 ? (expenses / deposit * 100) : 0;
                percExpensesInput.value = percentage.toFixed(2);
            }
            
            // Se preencher Despesas (%), calcula R$
            if (document.activeElement === percExpensesInput && percExpensesInput.value) {
                const percentage = parseFloat(percExpensesInput.value);
                const expenses = deposit * (percentage / 100);
                expensesInput.value = Math.ceil(expenses * 100) / 100; // Arredonda para cima com 2 decimais
            }
        }

        // Fun√ß√£o para atualizar lucro
        function updateProfit() {
            const deposit = parseFloat(document.getElementById("Deposit").value) || 0;
            const expenses = parseFloat(document.getElementById("Expenses").value) || 0;
            document.getElementById("Profit").value = (deposit - expenses).toFixed(2);
        }

        // Gerar ID √∫nico baseado em timestamp
        function generateId() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, "0");
            const day = String(now.getDate()).padStart(2, "0");
            const hour = String(now.getHours()).padStart(2, "0");
            const minute = String(now.getMinutes()).padStart(2, "0");
            const second = String(now.getSeconds()).padStart(2, "0");
            return `${year}${month}${day}${hour}${minute}${second}`;
        }

        // CARREGAR LISTA
        function loadList() {
            const launchesRef = ref(db, "servicos/");
            onValue(launchesRef, snapshot => {
                allLaunches = [];
                const data = snapshot.val();
                
                if (data) {
                    // Converter para array
                    for (const [id, item] of Object.entries(data)) {
                        allLaunches.push({ id, ...item });
                    }
                }
                
                renderList();
            });
        }

        // RENDERIZAR LISTA COM FILTROS
        function renderList() {
            list.innerHTML = "";

            if (allLaunches.length === 0) {
                const emptyMsg = document.createElement("li");
                emptyMsg.className = "empty-message";
                emptyMsg.textContent = "Nenhum lan√ßamento encontrado.";
                list.appendChild(emptyMsg);
                return;
            }

            // Aplicar filtro de status
            let filteredLaunches = allLaunches;
            if (currentStatusFilter !== 'all') {
                filteredLaunches = allLaunches.filter(item => 
                    String(item.Status) === currentStatusFilter
                );
            }

            // Ordenar lan√ßamentos
            filteredLaunches.sort((a, b) => {
                switch (currentSort) {
                    case 'processedDateDesc':
                        return new Date(b.ProcessedDate || 0) - new Date(a.ProcessedDate || 0);
                    case 'processedDateAsc':
                        return new Date(a.ProcessedDate || 0) - new Date(b.ProcessedDate || 0);
                    case 'requestDesc':
                        return new Date(b.Request || 0) - new Date(a.Request || 0);
                    case 'requestAsc':
                        return new Date(a.Request || 0) - new Date(b.Request || 0);
                    case 'deliveryDesc':
                        return new Date(b.Delivery || 0) - new Date(a.Delivery || 0);
                    case 'deliveryAsc':
                        return new Date(a.Delivery || 0) - new Date(b.Delivery || 0);
                    case 'customerAsc':
                        return (a.Customer || '').localeCompare(b.Customer || '');
                    case 'customerDesc':
                        return (b.Customer || '').localeCompare(a.Customer || '');
                    default:
                        return new Date(b.ProcessedDate || 0) - new Date(a.ProcessedDate || 0);
                }
            });

            // Renderizar cada item
            filteredLaunches.forEach(item => {
                const li = document.createElement("li");
                li.className = "list-item";
                
                // Verificar se est√° pendente de ProcessedDate
                if (!item.ProcessedDate || item.ProcessedDate.trim() === '') {
                    li.classList.add('pending-processed');
                }
                
                // Formatar datas para exibi√ß√£o
                const processedDate = item.ProcessedDate ? 
                    new Date(item.ProcessedDate).toLocaleDateString('pt-BR') : 
                    '<span class="pending-text">PENDENTE</span>';
                
                const requestDate = item.Request ? 
                    new Date(item.Request).toLocaleDateString('pt-BR') : 
                    'N√£o informada';
                
                const deliveryDate = item.Delivery ? 
                    new Date(item.Delivery).toLocaleDateString('pt-BR') : 
                    'N√£o informada';
                
                // Criar conte√∫do do item
                const itemContent = document.createElement("div");
                itemContent.className = "item-content";
                itemContent.innerHTML = `
                    <div class="item-main">
                        <strong>${item.Customer || 'Sem cliente'}</strong> - 
                        ${item.Business || 'Sem empresa'} - 
                        R$ ${parseFloat(item.Deposit || 0).toFixed(2)}
                    </div>
                    <div class="item-details">
                        <small>Processada: ${processedDate} | Pedido: ${requestDate} | Entrega: ${deliveryDate}</small>
                        <br>
                        <small>Status: ${getStatusText(item.Status)} | Lucro: R$ ${parseFloat(item.Profit || 0).toFixed(2)}</small>
                    </div>
                `;
                
                // Container para bot√µes de a√ß√£o
                const actionButtons = document.createElement("div");
                actionButtons.className = "action-buttons";
                
                // Bot√£o para reutilizar dados
                const reuseBtn = document.createElement("button");
                reuseBtn.className = "action-btn reuse-btn";
                reuseBtn.innerHTML = "‚Üª";
                reuseBtn.title = "Reutilizar dados para novo cadastro";
                reuseBtn.onclick = (e) => {
                    e.stopPropagation();
                    reuseDataForNew(item);
                };
                
                // Bot√£o para excluir
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "action-btn delete-btn";
                deleteBtn.innerHTML = "üóë";
                deleteBtn.title = "Excluir este lan√ßamento";
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteLaunch(item.id, item.Customer || 'este lan√ßamento');
                };
                
                actionButtons.appendChild(reuseBtn);
                actionButtons.appendChild(deleteBtn);
                
                li.appendChild(itemContent);
                li.appendChild(actionButtons);
                
                // Clique para editar
                li.onclick = () => loadForm(item.id, item);
                
                list.appendChild(li);
            });
        }

        // Fun√ß√£o para excluir lan√ßamento
        function deleteLaunch(id, itemName) {
            if (!confirm(`Tem certeza que deseja excluir "${itemName}"?\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }
            
            remove(ref(db, "servicos/" + id))
                .then(() => {
                    alert("Lan√ßamento exclu√≠do com sucesso!");
                    loadList();
                })
                .catch(error => {
                    console.error("Erro ao excluir:", error);
                    alert("Erro ao excluir lan√ßamento!");
                });
        }

        // Fun√ß√£o para reutilizar dados
        function reuseDataForNew(item) {
            // Limpa o ID selecionado para criar novo
            selectedId = null;
            
            // Preenche campos, mas limpa alguns
            for (const key in item) {
                if (document.getElementById(key)) {
                    // N√£o copia ID, datas espec√≠ficas e alguns campos
                    if (!['ProcessedDate', 'Request', 'Delivery'].includes(key)) {
                        document.getElementById(key).value = item[key] || "";
                    }
                }
            }
            
            // Define data atual para ProcessedDate
            const today = new Date().toISOString().split('T')[0];
            document.getElementById("ProcessedDate").value = today;
            
            // Atualiza bot√µes (modo "Salvar Novo")
            showSaveMode();
            
            // Atualiza c√°lculos
            handleExpensesCalculation();
            updateProfit();
            formChanged = true;
        }

        // Fun√ß√£o para obter texto do status
        function getStatusText(statusCode) {
            const statusMap = {
                '1': 'Conclu√≠do',
                '2': 'Em andamento',
                '3': 'Aguardando',
                '4': 'Cancelado'
            };
            return statusMap[statusCode] || 'Desconhecido';
        }

        // CARREGAR ITEM NO FORM
        function loadForm(id, item) {
            selectedId = id;
            formChanged = false;

            // Preenche todos os campos
            for (const key in item) {
                if (document.getElementById(key)) {
                    document.getElementById(key).value = item[key] || "";
                }
            }

            // Atualiza c√°lculos
            handleExpensesCalculation();
            updateProfit();
            
            // Muda para modo "Alterar"
            showUpdateMode();
        }

        // Mostrar modo SALVAR (novo cadastro)
        function showSaveMode() {
            saveBtn.style.display = "block";
            updateBtn.style.display = "none";
            clearBtn.style.display = "none";
            saveBtn.textContent = "Salvar Novo";
        }

        // Mostrar modo ALTERAR (edi√ß√£o)
        function showUpdateMode() {
            saveBtn.style.display = "none";
            updateBtn.style.display = "block";
            clearBtn.style.display = "block";
        }

        // LIMPAR CAMPOS
        clearBtn.addEventListener("click", () => {
            selectedId = null;
            formChanged = false;
            
            // Limpa todos os campos
            fields.forEach(f => f.value = "");
            document.getElementById("Profit").value = "";
            
            // Volta para modo "Salvar Novo"
            showSaveMode();
        });

        // SALVAR NOVO
        saveBtn.addEventListener("click", () => {
            if (!validateForm()) return;
            
            const obj = collectFormData();
            
            // Gera novo ID e salva
            const id = generateId();
            set(ref(db, "servicos/" + id), obj)
                .then(() => {
                    alert("Lan√ßamento salvo com sucesso!");
                    resetForm();
                    loadList();
                })
                .catch(error => {
                    console.error("Erro ao salvar:", error);
                    alert("Erro ao salvar lan√ßamento!");
                });
        });

        // ALTERAR EXISTENTE
        updateBtn.addEventListener("click", () => {
            if (!validateForm()) return;
            if (!selectedId) {
                alert("Nenhum item selecionado para alterar!");
                return;
            }
            
            const obj = collectFormData();
            
            update(ref(db, "servicos/" + selectedId), obj)
                .then(() => {
                    alert("Lan√ßamento alterado com sucesso!");
                    resetForm();
                    loadList();
                })
                .catch(error => {
                    console.error("Erro ao alterar:", error);
                    alert("Erro ao alterar lan√ßamento!");
                });
        });

        // Coletar dados do formul√°rio
        function collectFormData() {
            const obj = {};
            fields.forEach(f => {
                // Converte n√∫meros
                if (f.type === 'number') {
                    obj[f.id] = f.value ? parseFloat(f.value) : 0;
                } else {
                    obj[f.id] = f.value || "";
                }
            });
            obj.Profit = parseFloat(document.getElementById("Profit").value) || 0;
            return obj;
        }

        // Validar formul√°rio
        function validateForm() {
            const customer = document.getElementById("Customer").value;
            const deposit = document.getElementById("Deposit").value;
            
            if (!customer || customer.trim() === "") {
                alert("Por favor, preencha o campo Cliente!");
                document.getElementById("Customer").focus();
                return false;
            }
            
            if (!deposit || parseFloat(deposit) <= 0) {
                alert("Por favor, preencha um valor de Dep√≥sito v√°lido!");
                document.getElementById("Deposit").focus();
                return false;
            }
            
            return true;
        }

        // Resetar formul√°rio
        function resetForm() {
            selectedId = null;
            formChanged = false;
            fields.forEach(f => f.value = "");
            document.getElementById("Profit").value = "";
            showSaveMode();
        }

        // AVISO AO SAIR SEM SALVAR
        window.onbeforeunload = (e) => {
            if (formChanged) {
                e.preventDefault();
                e.returnValue = "H√° altera√ß√µes n√£o salvas. Deseja realmente sair?";
                return "H√° altera√ß√µes n√£o salvas. Deseja realmente sair?";
            }
        };

        // Inicializar
        loadList();
        showSaveMode(); // Come√ßa no modo "Salvar Novo"

    </script>

</body>
</html>