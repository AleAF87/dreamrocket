<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Dream Rocket</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">

    <!-- Firebase Scripts -->
    <script type="module" src="js/firebase-config.js"></script>
    
    <!-- Proteção de página -->
    <script type="module">
        import { protectPage } from "./js/auth.js";
        protectPage();
    </script>
    
    <!-- Dashboard JS -->
    <script type="module" src="js/dashboard.js" defer></script>
</head>

<body>
    <!-- NAVBAR -->
    <div id="navbar"></div>

    <h2>Dashboard de Movimentações</h2>

    <div class="dash-container">

        <!-- LISTA DE LANÇAMENTOS -->
        <div class="list-area">
            <h3>Lançamentos</h3>
            
            <!-- Filtros -->
            <div class="filters-container">
                <div class="filter-group">
                    <label for="sortFilter">Ordenar por:</label>
                    <select id="sortFilter" class="filter-select">
                        <option value="default" selected>Padrão</option>
                        <option value="processedDateDesc">Data pagamento (Mais Recente)</option>
                        <option value="processedDateAsc">Data pagamento (Mais Antiga)</option>
                        <option value="requestDesc">Data do pedido (Mais Recente)</option>
                        <option value="requestAsc">Data do pedido (Mais Antiga)</option>
                        <option value="deliveryDesc">Data de entrega (Mais Recente)</option>
                        <option value="deliveryAsc">Data de entrega (Mais Antiga)</option>
                        <option value="customerAsc">Cliente (A-Z)</option>
                        <option value="customerDesc">Cliente (Z-A)</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="statusFilter">Filtrar por Status:</label>
                    <select id="statusFilter" class="filter-select">
                        <option value="all">Todos os Status</option>
                        <option value="1">Concluído</option>
                        <option value="2">Em andamento</option>
                        <option value="3">Aguardando</option>
                        <option value="4">Cancelado</option>
                    </select>
                </div>
            </div>
            
            <ul id="launchList" class="list"></ul>
        </div>

        <!-- FORMULÁRIO -->
        <div class="form-area">
            <h3>Editar / Novo Lançamento</h3>

            <div class="form-grid">
                <div>
                    <label for="Customer">Cliente:</label>
                    <input id="Customer" data-field placeholder="Nome do cliente">
                </div>
                
                <div>
                    <label for="Business">Empresa:</label>
                    <input id="Business" data-field placeholder="Nome da empresa">
                </div>
                
                <div>
                    <label for="Identification">Identificação:</label>
                    <input id="Identification" data-field placeholder="CPF/CNPJ ou código">
                </div>
                
                <div>
                    <label for="Description">Descrição:</label>
                    <input id="Description" data-field placeholder="Descrição do serviço">
                </div>
                
                <div>
                    <label for="Request">Data do Pedido:</label>
                    <input type="date" id="Request" data-field>
                </div>
                
                <div>
                    <label for="Delivery">Data de Entrega:</label>
                    <input type="date" id="Delivery" data-field>
                </div>
                
                <div>
                    <label for="ProcessedDate">Data Processada:</label>
                    <input type="date" id="ProcessedDate" data-field>
                </div>
                
                <div>
                    <label for="Deposit">Depósito (Total):</label>
                    <input type="number" id="Deposit" data-field placeholder="0.00" step="0.01">
                </div>

                <div>
                    <label for="Expenses">Despesas (R$):</label>
                    <input type="number" id="Expenses" data-field placeholder="0.00" step="0.01">
                </div>
                
                <div>
                    <label for="PercExpenses">Despesas (%):</label>
                    <input type="number" id="PercExpenses" data-field placeholder="0.00" step="0.01">
                </div>
                
                <div>
                    <label for="Profit">Lucro Bruto:</label>
                    <input id="Profit" placeholder="0.00" readonly>
                    <small style="color: #666; font-size: 0.8em;">Depósito - Despesas</small>
                </div>
                
                <div>
                    <label for="Discount">Desconto:</label>
                    <input type="number" id="Discount" data-field placeholder="0.00" step="0.01">
                </div>
                
                <div>
                    <label for="NetProfit">Lucro Líquido:</label>
                    <input id="NetProfit" placeholder="0.00" readonly>
                    <small style="color: #666; font-size: 0.8em;">Lucro Bruto - Desconto</small>
                </div>

                <!-- SEÇÃO DE PARCELAMENTO -->
                <div class="form-section" style="grid-column: span 2; border: 1px solid #ddd; padding: 10px; border-radius: 5px; margin: 5px 0;">
                    <h4 style="margin-top: 0; color: #333;">Parcelamento</h4>
                    
                    <!-- Configuração do parcelamento -->
                    <div class="installment-config" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label for="paymentMethod">Forma de Pagamento:</label>
                            <select id="paymentMethod" data-field style="width: 100%;">
                                <option value="pix">PIX</option>
                                <option value="cartao_sem">Cartão (s/ juros)</option>
                                <option value="cartao_com">Cartão (c/ juros)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="installmentCount">Número de Parcelas:</label>
                            <select id="installmentCount" data-field style="width: 100%;">
                                <option value="1">1x</option>
                                <option value="2">2x</option>
                                <option value="3">3x</option>
                                <option value="4">4x</option>
                                <option value="5">5x</option>
                                <option value="6">6x</option>
                                <option value="7">7x</option>
                                <option value="8">8x</option>
                                <option value="9">9x</option>
                                <option value="10">10x</option>
                                <option value="11">11x</option>
                                <option value="12">12x</option>
                            </select>
                        </div>
                    </div>

                    <!-- Controle de data da primeira parcela -->
                    <div id="firstInstallmentContainer" style="margin-top: 10px; display: none;">
                        <label for="firstInstallmentDate">Data da 1ª Parcela:</label>
                        <input type="date" id="firstInstallmentDate" data-field style="width: 100%;">
                        <small style="color: #666;">As demais parcelas serão calculadas automaticamente (1 mês de diferença cada)</small>
                    </div>

                    <!-- Tabela de parcelas -->
                    <div class="installments-table-container">
                        <table id="installmentsTable" style="width: 100%; border-collapse: collapse; display: none;">
                            <thead>
                                <tr style="background-color: #f5f5f5;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Parcela</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Data de Vencimento</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Valor da Parcela</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Juros</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Valor com Juros</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="installmentsTableBody">
                                <!-- Parcelas serão geradas aqui dinamicamente -->
                            </tbody>
                            <tfoot id="installmentsTableFooter" style="display: none;">
                                <tr style="background-color: #f9f9f9;">
                                    <td colspan="2" style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Total:</td>
                                    <td id="totalInstallmentValue" style="padding: 8px; border: 1px solid #ddd;"></td>
                                    <td id="totalInterestValue" style="padding: 8px; border: 1px solid #ddd;"></td>
                                    <td id="totalFinalValue" style="padding: 8px; border: 1px solid #ddd; font-weight: bold;"></td>
                                    <td style="padding: 8px; border: 1px solid #ddd;"></td>
                                </tr>
                                <tr style="background-color: #fff8e1;">
                                    <td colspan="2" style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Valor Total Informado:</td>
                                    <td colspan="3" id="totalInformedValue" style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #d32f2f;">R$ 0,00</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">
                                        <span id="totalDifference" style="font-size: 0.9em;"></span>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <button type="button" id="showInstallmentsBtn" style="display: none; margin-top: 10px; padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Mostrar/Editar Parcelas
                        </button>
                    </div>

                    <!-- Controle de data da primeira parcela -->
                    <div id="firstInstallmentContainer" style="margin-top: 10px; display: none;">
                        <label for="firstInstallmentDate">Data da 1ª Parcela:</label>
                        <input type="date" id="firstInstallmentDate" data-field style="width: 100%;">
                        <small style="color: #666;">As demais parcelas serão calculadas automaticamente (1 mês de diferença cada)</small>
                    </div>
                </div>
                <!-- FIM SEÇÃO PARCELAMENTO -->

                <div>
                    <label for="Status">Status:</label>
                    <select id="Status" data-field>
                        <option value="1">Concluído</option>
                        <option value="2">Em andamento</option>
                        <option value="3">Aguardando</option>
                        <option value="4">Cancelado</option>
                    </select>
                </div>

                <div id="reasonContainer" style="display: none; grid-column: span 2;">
                    <label for="Reason">Motivo do Aguardamento:</label>
                    <textarea id="Reason" data-field placeholder="Descreva o motivo do aguardamento..."></textarea>
                </div>

                <div style="grid-column: span 2;">
                    <label for="Observation">Observações:</label>
                    <textarea id="Observation" data-field placeholder="Observações adicionais..."></textarea>
                </div>

                <!-- SEÇÃO DE LANÇAMENTO DE TEMPO E HISTÓRICO -->
                <div class="form-section" style="grid-column: span 2; border: 1px solid #ddd; padding: 10px; border-radius: 5px; margin: 5px 0;">
                    <h4 style="margin-top: 0; color: #333;">Histórico de Serviço</h4>
                    
                    <!-- Formulário para adicionar novo lançamento de tempo -->
                    <div class="time-entry-form" style="display: grid; grid-template-columns: 1fr 1fr 2fr auto; gap: 10px; margin-bottom: 15px; align-items: end;">
                        <div>
                            <label for="workDate">Data:</label>
                            <input type="date" id="workDate" style="width: 100%;">
                        </div>
                        
                        <div>
                            <label for="workHours">Tempo (horas):</label>
                            <input type="number" id="workHours" step="0.5" min="0" placeholder="Ex: 3.5" style="width: 100%;">
                        </div>
                        
                        <div>
                            <label for="workDescription">Serviço:</label>
                            <input type="text" id="workDescription" placeholder="Ex: Corte e fitamento das chapas" style="width: 100%;">
                        </div>
                        
                        <div>
                            <button type="button" id="addWorkEntryBtn" class="btn-secondary" style="padding: 8px 12px; white-space: nowrap;">
                                + Adicionar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de histórico -->
                    <div class="work-history-container">
                        <h5 style="margin-top: 0; color: #666;">Histórico Registrado:</h5>
                        <div id="workHistoryList" class="history-list">
                            <!-- Histórico será gerado dinamicamente aqui -->
                        </div>
                    </div>
                </div>

                <!-- Modal para visualizar/editar histórico -->
                <div id="workHistoryModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 style="margin: 0;">Detalhes do Serviço</h3>
                            <span class="close-modal">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="modal-form">
                                <div>
                                    <label for="modalWorkDate">Data:</label>
                                    <input type="date" id="modalWorkDate">
                                </div>
                                <div>
                                    <label for="modalWorkHours">Tempo (horas):</label>
                                    <input type="number" id="modalWorkHours" step="0.5" min="0">
                                </div>
                                <div>
                                    <label for="modalWorkDescription">Serviço:</label>
                                    <textarea id="modalWorkDescription" rows="3"></textarea>
                                </div>
                                <div class="modal-actions">
                                    <button id="updateWorkEntryBtn" class="btn-primary">Salvar Alterações</button>
                                    <button id="deleteWorkEntryBtn" class="btn-danger">Excluir</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botões de ação -->
                <div class="button-group" style="grid-column: span 2;">
                    <button id="saveBtn" class="save-btn btn-success">Salvar Novo</button>
                    <button id="updateBtn" class="update-btn btn-primary" style="display: none;">Alterar</button>
                    <button id="clearBtn" class="clear-btn btn-danger" style="display: none;">Limpar Campos</button>
                </div>
            </div>
        </div>

    </div>

</body>
</html>